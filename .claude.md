# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the **Traffic Tacos Proto Contracts** repository - a centralized gRPC protocol definition system for the Traffic Tacos microservices platform. This repository serves as the single source of truth for all inter-service communication contracts in a system designed to handle **30k RPS traffic**.

## Repository Purpose

**Centralized gRPC Contracts**: All services (gateway-api, reservation-api, inventory-api, payment-sim-api, reservation-worker) depend on this repository for their gRPC communication interfaces.

**Multi-Language Support**: Generates code for both Go (gateway, inventory, payment-sim, worker) and Kotlin/Java (reservation-api) ecosystems.

## Architecture

### Service Layer Overview
```
Layer 1: Gateway (Go) → Layer 2: Business Services (Go/Kotlin) → Layer 3: Worker (Go/Kotlin)
```

**Key Services Defined**:
- **ReservationService**: 60-second hold mechanism, EventBridge integration
- **Inventory**: Zero-oversell guarantee via DynamoDB conditional updates
- **PaymentService**: Payment simulation with webhook support

## Development Commands

### Essential Commands
```bash
# Initialize repository
make init

# Generate code for all languages
make generate

# Generate specific language
make generate-go        # For Go services
make generate-kotlin    # For Kotlin services

# Development workflow
make dev               # clean + generate + test

# CI workflow
make ci                # lint + breaking + generate + test

# Check project status
make status
```

### Manual Generation Scripts
```bash
# Use when make is not available
./scripts/generate-go.sh
./scripts/generate-kotlin.sh
./scripts/publish.sh
```

## Code Generation

### Buf Configuration
- **buf.yaml**: Linting and breaking change detection
- **buf.gen.yaml**: Multi-language code generation configuration
- Generates to `gen/go/` and `gen/java/` directories

### Generated Packages
**Go packages**:
```go
import (
    commonv1 "github.com/traffic-tacos/proto-contracts/gen/go/common/v1"
    reservationv1 "github.com/traffic-tacos/proto-contracts/gen/go/reservation/v1"
    paymentv1 "github.com/traffic-tacos/proto-contracts/gen/go/payment/v1"
)
```

**Kotlin packages**:
```kotlin
dependencies {
    implementation("com.traffic-tacos:proto-contracts:1.0.0")
}
import com.traffic_tacos.reservation.v1.ReservationServiceGrpcKt
```

## Proto Structure

### Directory Layout
```
proto/
├── common/v1/          # Shared types (Money, Error, Event, Seat)
├── reservation/v1/     # Reservation + Inventory services
├── payment/v1/         # Payment simulation service
└── gateway/v1/         # Gateway-specific protocols (future)
```

### Key Message Types
- **common.v1.Money**: Monetary amounts with currency
- **common.v1.Error**: Standardized error responses
- **common.v1.Event/Seat**: Core domain objects
- **ReservationStatus**: PENDING, CONFIRMED, CANCELLED, EXPIRED
- **PaymentStatus**: PENDING, COMPLETED, FAILED, REFUNDED

## Development Guidelines

### Proto File Conventions
- Use `snake_case` for field names
- Use `PascalCase` for messages/services
- Use `SCREAMING_SNAKE_CASE` for enums
- Never reuse field numbers
- Always maintain backward compatibility

### Versioning Strategy
- **v1.x.x**: Current stable version
- Breaking changes require major version bump
- New fields/services use minor version bump
- Bug fixes use patch version bump

### Testing Requirements
- All proto changes must generate valid Go and Kotlin code
- Run `make ci` before submitting changes
- Breaking change detection via `buf breaking`

## Important Notes

### AWS Profile Requirement
- Services use `tacos` AWS profile for authentication
- Local development uses LocalStack for AWS simulation

### Performance Targets
- **30k RPS** system-wide throughput
- **P95 < 500ms** latency target
- **gRPC timeout**: ≤ 250ms for inventory calls

### Service Dependencies
Changes to this repository trigger updates in:
- gateway-api (Go + Fiber)
- reservation-api (Kotlin + Spring Boot)
- inventory-api (Go + gRPC)
- payment-sim-api (Go + Echo)
- reservation-worker (Go/Kotlin + K8s Job)

## CI/CD Pipeline

### Automated Workflows
- **CI**: Lint, generate, test on every PR
- **Release**: Automatic publishing on git tags
- **Cross-repo**: Notifies dependent services on release

### Release Process
1. Create feature branch
2. Make proto changes
3. Run `make dev` to test
4. Submit PR
5. After merge, tag release: `git tag v1.x.x`
6. Push tag triggers automated release

## Troubleshooting

### Common Issues
- **"buf not found"**: Install buf from https://buf.build/
- **"protoc-gen-go not found"**: Run `make deps`
- **Generation fails**: Check proto syntax with `make lint`
- **Breaking changes**: Use `make breaking` to detect issues

### When to Regenerate
- After any proto file changes
- Before testing integration with services
- Before releasing new versions
- When buf.gen.yaml is modified

This repository is the foundation of the Traffic Tacos MSA platform's communication layer. All changes should be carefully considered for their impact across the entire service ecosystem.